<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dépot des Talons – Transport E.L.Z</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Comfortaa", sans-serif;
        background: #f6f6f6;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      header {
        background-color: #111;
        width: 100%;
        padding: 20px 0;
        text-align: center;
      }
      header img {
        height: 50px;
      }
      main {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 500px;
        width: 90%;
        margin: 40px auto;
      }
      select,
      input[type="file"] {
        padding: 12px;
        margin: 10px 0;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
      }
      input[type="file"]::-webkit-file-upload-button {
        padding: 12px 20px;
        margin-right: 10px;
        background-color: #000;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
      }
      input[type="file"]::-moz-file-upload-button {
        padding: 12px 20px;
        background-color: #000;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
      }
      button {
        background-color: #000;
        color: white;
        padding: 12px;
        margin-top: 10px;
        width: 100%;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
      }
      button:hover {
        background-color: #333;
      }
      #message {
        margin-top: 15px;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <header>
      <img src="assets/logo.jpeg" alt="Logo Transportelz" />
    </header>

    <main>
      <h2>Dépot des Talons de paie</h2>

      <label>Choisir l’employé :</label>
      <select id="employeSelect"></select>

      <label>Sélectionner la semaine :</label>
      <select id="weekSelect"></select>

      <label>Sélectionner le PDF :</label>
      <input type="file" id="fileInput" accept="application/pdf" />

      <button id="uploadBtn">Uploader le PDF</button>

      <p id="message"></p>
    </main>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
      // --- CONFIGURATION FIREBASE ---
      const firebaseConfig = {
        apiKey: "AIzaSyAxbpNoGfMEK5N6sy3WYWMTD3WGelff0QA",
        authDomain: "transportelz.firebaseapp.com",
        projectId: "transportelz",
        storageBucket: "transportelz.firebasestorage.app", // bucket confirmé
        messagingSenderId: "290260714729",
        appId: "1:290260714729:web:a433a445eb44fe5404dc78",
      };
      firebase.initializeApp(firebaseConfig);

      const storage = firebase.storage();
      const auth = firebase.auth();

      // (tu peux laisser ou retirer l'auth anonyme selon tes règles Storage)
      auth
        .signInAnonymously()
        .catch((e) => console.error("Anon auth error:", e));

      // --- LISTE DES UTILISATEURS ---
      // Ajoute ici les noms à afficher pour chaque identifiant (ex. md160 -> Mathieu Denis)
      const displayNames = {
        sr01: "Steeve Richard",
        md160: "Mathieu Denis",
        jj04: "Jean-Francois Jobin",
        bp10: "Bernard Piché",
        rp16: "Raymond Petitclerc",
        dm17: "Dominic Martel",
        mo26: "Martin Ouellet",
        al34: "Alain Lemieux",
        pf36: "Patrick Frenette",
        rb55: "Remi Bédard",
        rd128: "Rejean Dupuis",
        ym139: "Yanick Meunier",
        bp145: "Mathieu Denis",
        sr146: "Simon Renaud",
        ap150: "Alain Pelletier",
        yp151: "Yanick Piché",
        ac155: "Alain Cantin",
        gd161: "Gaétan Denis",
        cyr162: "Clément Requoi",
        cem165: "Charles-Étienne Martel",
      };

      const utilisateurs = [
        { identifiant: "sr01", role: "user" },
        { identifiant: "md160", role: "user" },
        { identifiant: "jj04", role: "user" },
        { identifiant: "bp10", role: "user" },
        { identifiant: "rp16", role: "user" },
        { identifiant: "dm17", role: "user" },
        { identifiant: "mo26", role: "user" },
        { identifiant: "al34", role: "user" },
        { identifiant: "pf36", role: "user" },
        { identifiant: "rb55", role: "user" },
        { identifiant: "rd128", role: "user" },
        { identifiant: "ym139", role: "user" },
        { identifiant: "bp145", role: "user" },
        { identifiant: "sr146", role: "user" },
        { identifiant: "ap150", role: "user" },
        { identifiant: "yp151", role: "user" },
        { identifiant: "ac155", role: "user" },
        { identifiant: "gd161", role: "user" },
        { identifiant: "cyr162", role: "user" },
        { identifiant: "cem165", role: "user" },
      ];

      const employeSelect = document.getElementById("employeSelect");
      const weekSelect = document.getElementById("weekSelect");
      const uploadBtn = document.getElementById("uploadBtn");
      const fileInput = document.getElementById("fileInput");
      const message = document.getElementById("message");

      // Remplir select employés : valeur = code, libellé = nom si connu (sinon code)
      utilisateurs.forEach((u) => {
        const opt = document.createElement("option");
        opt.value = u.identifiant; // reste le code pour le chemin Storage
        const label = displayNames[u.identifiant] || u.identifiant;
        opt.textContent = label;
        // (optionnel) tooltip avec le code
        opt.title = u.identifiant;
        employeSelect.appendChild(opt);
      });

      // Remplir select semaines
      const currentYear = new Date().getFullYear();
      for (let i = 1; i <= 52; i++) {
        const opt = document.createElement("option");
        opt.value = `${currentYear}-W${String(i).padStart(2, "0")}`;
        opt.textContent = `Semaine ${i}, ${currentYear}`;
        weekSelect.appendChild(opt);
      }

      // Helper: ref GS pour viser le bon bucket
      const BUCKET_GS = "gs://transportelz.firebasestorage.app";
      function gsPathFor(user, week) {
        return `${BUCKET_GS}/talons/${user}/${week}.pdf`;
      }

      // --- UPLOAD PDF ---
      uploadBtn.addEventListener("click", async () => {
        const selectedUser = employeSelect.value; // ← code (ex. md160)
        const selectedWeek = weekSelect.value;
        const file = fileInput.files[0];

        if (!file) {
          message.style.color = "crimson";
          message.textContent = "Veuillez sélectionner un PDF.";
          return;
        }
        if (file.type !== "application/pdf") {
          message.style.color = "crimson";
          message.textContent = "Seuls les PDF sont acceptés.";
          return;
        }

        try {
          const fileRef = storage.refFromURL(
            gsPathFor(selectedUser, selectedWeek)
          );
          const metadata = { contentType: "application/pdf" };
          await fileRef.put(file, metadata);

          message.style.color = "green";
          message.textContent = "PDF téléchargé avec succès !";
          fileInput.value = "";
        } catch (err) {
          console.error(err);
          message.style.color = "crimson";
          message.textContent = "Erreur lors de l’upload : " + err.message;
        }
      });
    </script>
  </body>
</html>
