<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prix du Diesel - Transport ELZ</title>
    <link rel="icon" type="image/png" href="assets/favicon.png" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Comfortaa", sans-serif;
        background: linear-gradient(
          135deg,
          #e74c3c 0%,
          #c0392b 25%,
          #a93226 50%,
          #7b241c 75%,
          #2c3e50 100%
        );
        background-size: 400% 400%;
        animation: gradientShift 8s ease infinite;
        min-height: 100vh;
        color: white;
        overflow-x: hidden;
        padding: 20px;
      }

      @keyframes gradientShift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .back-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        color: white;
        padding: 12px 20px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        gap: 8px;
        z-index: 1000;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        color: white;
        text-decoration: none;
      }

      .fuel-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        margin-bottom: 30px;
      }

      .fuel-table {
        width: 100%;
        border-collapse: collapse;
        background: transparent;
      }

      .fuel-table thead {
        background: rgba(231, 76, 60, 0.3);
      }

      .fuel-table th {
        padding: 20px;
        text-align: left;
        font-weight: 600;
        font-size: 1.1rem;
        color: white;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .fuel-table th:last-child {
        text-align: center;
      }

      .fuel-table td {
        padding: 15px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 1rem;
        color: white;
        transition: background 0.3s ease;
      }

      .fuel-table td:first-child {
        font-weight: 500;
      }

      .fuel-table td:last-child {
        text-align: center;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .fuel-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .fuel-table tr.subsection {
        background: rgba(255, 255, 255, 0.1);
        font-weight: 700;
        font-style: italic;
      }

      .fuel-table tr.subsection td {
        padding: 12px 20px;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #ffffff;
        background: rgba(231, 76, 60, 0.3);
        font-weight: 700;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }

      .fuel-table tr.date-row {
        background: rgba(39, 174, 96, 0.2);
        font-weight: 600;
      }

      .fuel-table tr.date-row td {
        color: #27ae60;
        font-size: 1.1rem;
        text-align: center;
      }

      .fuel-table tr.date-row td:first-child {
        text-align: center;
      }

      .price-value {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        display: inline-block;
        box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        position: relative;
      }

      .best-price-badge {
        position: absolute;
        top: -12px;
        right: -12px;
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: white;
        font-size: 0.6rem;
        font-weight: 700;
        padding: 3px 6px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(243, 156, 18, 0.4);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        z-index: 10;
        white-space: nowrap;
        animation: pulse 2s infinite;
        transform: scale(0.9);
        line-height: 1;
      }

      @keyframes pulse {
        0% {
          transform: scale(0.9);
        }
        50% {
          transform: scale(0.95);
        }
        100% {
          transform: scale(0.9);
        }
      }

      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9998;
        backdrop-filter: blur(10px);
      }

      .loading-screen.show {
        display: flex;
      }

      .loader {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid #e74c3c;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background: rgba(231, 76, 60, 0.2);
        border: 2px solid rgba(231, 76, 60, 0.4);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        color: #e74c3c;
        font-weight: 600;
        margin: 20px 0;
      }

      .last-updated {
        text-align: center;
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 20px;
        color: #e8e8e8;
      }

      /* Mobile optimizations */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .fuel-container {
          margin: 0 -5px;
        }

        .fuel-table th,
        .fuel-table td {
          padding: 12px 15px;
          font-size: 0.9rem;
        }

        .fuel-table th {
          font-size: 1rem;
        }

        .fuel-table td:last-child {
          font-size: 1rem;
        }

        .back-btn {
          position: relative;
          top: auto;
          left: auto;
          margin-bottom: 15px;
          width: fit-content;
        }

        .price-value {
          padding: 6px 12px;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        .fuel-table th,
        .fuel-table td {
          padding: 10px 12px;
          font-size: 0.8rem;
        }

        .fuel-table th {
          font-size: 0.9rem;
        }

        .price-value {
          padding: 4px 8px;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>

  <body>
    <a href="linktreev2.html" class="back-btn"> ← Retour </a>

    <div class="container">
      <div class="header">
        <h1>⛽ Prix du Diesel</h1>
        <p>Consultez les prix actuels du carburant</p>
      </div>

      <div class="fuel-container">
        <table class="fuel-table" id="prixTable">
          <thead>
            <tr>
              <th>Endroit</th>
              <th>Prix</th>
            </tr>
          </thead>
          <tbody>
            <!-- Rempli dynamiquement -->
          </tbody>
        </table>
      </div>

      <div class="last-updated" id="lastUpdated">
        Dernière mise à jour: Chargement...
      </div>
    </div>

    <div id="loading-screen" class="loading-screen">
      <div class="loader"></div>
    </div>

    <script>
      const apiUrl =
        "https://script.google.com/macros/s/AKfycbxOlc8H2lw4e3pF0FViso7ds1LTYjW_Z8jdEbeLh634fE-fV4LGRvgp-CAe2M7mQCPQ/exec";

      function formatPrix(valeur) {
        const num = parseFloat(valeur);
        return isNaN(num) ? "" : num.toFixed(4).replace(".", ",");
      }

      function formatDateFr(date) {
        return date
          .toLocaleDateString("fr-CA", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
          })
          .split("-")
          .reverse()
          .join("/");
      }

      function formatTimeFr(date) {
        return date.toLocaleTimeString("fr-CA", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function showLoading() {
        const loading = document.getElementById("loading-screen");
        loading.classList.add("show");
      }

      function hideLoading() {
        const loading = document.getElementById("loading-screen");
        loading.classList.remove("show");
      }

      function showError(message) {
        const container = document.querySelector(".fuel-container");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.innerHTML = `
          <i class="bi bi-exclamation-triangle"></i>
          <br><br>
          ${message}
        `;
        container.appendChild(errorDiv);
      }

      function updateLastUpdated() {
        const now = new Date();
        const lastUpdated = document.getElementById("lastUpdated");
        lastUpdated.textContent = `Dernière mise à jour: ${formatDateFr(
          now
        )} à ${formatTimeFr(now)}`;
      }

      async function loadData() {
        try {
          showLoading();
          const response = await fetch(apiUrl);

          if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
          }

          const data = await response.json();
          const tbody = document.querySelector("#prixTable tbody");
          const today = new Date();

          // Vider le contenu existant
          tbody.innerHTML = "";

          if (!data || data.length === 0) {
            showError("Aucune donnée disponible pour le moment");
            return;
          }

          // Analyser les données pour trouver les meilleurs prix par section
          const sectionPrices = {};
          let currentSection = null;

          data.forEach((row) => {
            const isSubSection = row.endroit && !row.prix;
            const isFirstDateLine =
              row.endroit &&
              row.endroit.toUpperCase().includes("LISTE DE PRIX");

            if (isSubSection) {
              currentSection = row.endroit;
              sectionPrices[currentSection] = [];
            } else if (row.prix && !isFirstDateLine) {
              const prix = parseFloat(row.prix);
              if (!isNaN(prix) && currentSection) {
                sectionPrices[currentSection].push({
                  endroit: row.endroit,
                  prix: prix,
                  prixFormatted: formatPrix(row.prix),
                });
              }
            }
          });

          // Trouver le meilleur prix pour chaque section
          const bestPrices = {};
          Object.keys(sectionPrices).forEach((section) => {
            if (sectionPrices[section].length > 1) {
              const prices = sectionPrices[section];
              const minPrice = Math.min(...prices.map((p) => p.prix));
              bestPrices[section] = minPrice;
            }
          });

          // Afficher les données
          currentSection = null;
          data.forEach((row, index) => {
            const tr = document.createElement("tr");
            const isSubSection = row.endroit && !row.prix;
            const isFirstDateLine =
              index === 0 &&
              row.endroit &&
              row.endroit.toUpperCase().includes("LISTE DE PRIX");

            const endroit = row.endroit || "";
            const prix = isFirstDateLine
              ? formatDateFr(today)
              : isSubSection
              ? ""
              : formatPrix(row.prix);

            tr.className = isFirstDateLine
              ? "date-row"
              : isSubSection
              ? "subsection"
              : "";

            if (isFirstDateLine) {
              tr.innerHTML = `
                 <td colspan="2" style="text-align: center;">📅 ${endroit} - ${prix}</td>
               `;
              tbody.appendChild(tr);
            } else if (isSubSection) {
              currentSection = row.endroit;
              tr.innerHTML = `
                 <td colspan="2">📍 ${endroit}</td>
               `;
              tbody.appendChild(tr);
            } else if (prix && prix.trim() !== "") {
              // Vérifier si c'est le meilleur prix de la section
              const isBestPrice =
                currentSection &&
                bestPrices[currentSection] &&
                parseFloat(row.prix) === bestPrices[currentSection];

              const badgeHtml = isBestPrice
                ? '<span class="best-price-badge">MEILLEUR</span>'
                : "";

              tr.innerHTML = `
                 <td>${endroit}</td>
                 <td><span class="price-value">${prix} $/L${badgeHtml}</span></td>
               `;
              tbody.appendChild(tr);
            }
          });

          updateLastUpdated();
        } catch (error) {
          console.error("Erreur lors du chargement des données :", error);
          showError(
            "Impossible de charger les données. Veuillez réessayer plus tard."
          );
        } finally {
          hideLoading();
        }
      }

      // Charger les données au chargement de la page
      document.addEventListener("DOMContentLoaded", loadData);

      // Recharger les données toutes les 5 minutes
      setInterval(loadData, 5 * 60 * 1000);
    </script>
  </body>
</html>
