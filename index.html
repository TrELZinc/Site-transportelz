<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Connexion – Transport E.L.Z inc.</title>
    <link rel="icon" type="image/png" href="assets/favicon.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Comfortaa", sans-serif;
        background: #f6f6f6;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      header {
        background-color: #111;
        width: 100%;
        padding: 20px 0;
        text-align: center;
      }

      header img {
        height: 50px;
      }

      form {
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 400px;
        width: 90%;
        margin: 40px auto;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }

      input[type="text"],
      input[type="password"] {
        padding: 12px;
        margin: 10px 0;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
      }

      button {
        background-color: #000;
        color: white;
        padding: 12px;
        width: 100%;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 10px;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        margin: 10px 0;
        gap: 8px;
        font-size: 14px;
        cursor: pointer;
      }

      .checkbox-group input[type="checkbox"] {
        appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid #000;
        border-radius: 4px;
        display: inline-block;
        position: relative;
        cursor: pointer;
      }

      .checkbox-group input[type="checkbox"]:checked::after {
        content: "\2713";
        font-size: 14px;
        position: absolute;
        top: -2px;
        left: 2px;
        color: #000;
      }

      #erreur {
        color: red;
        font-size: 14px;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <header>
      <img src="assets/logo.jpeg" alt="Logo Transportelz" />
    </header>

    <form id="loginForm">
      <h2>Connexion</h2>
      <input type="text" id="identifiant" placeholder="Identifiant" required />
      <input
        type="password"
        id="motdepasse"
        placeholder="Mot de passe"
        required
      />

      <label class="checkbox-group">
        <input type="checkbox" id="rememberMe" />
        Rester connecté
      </label>

      <button type="submit">Se connecter</button>
      <p id="erreur"></p>
    </form>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
      // Configuration Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAxbpNoGfMEK5N6sy3WYWMTD3WGelff0QA",
        authDomain: "transportelz.firebaseapp.com",
        projectId: "transportelz",
        storageBucket: "transportelz.firebasestorage.app",
        messagingSenderId: "290260714729",
        appId: "1:290260714729:web:a433a445eb44fe5404dc78",
        measurementId: "G-EKZYPTGFT7",
      };
      firebase.initializeApp(firebaseConfig);

      let utilisateurs = [];

      // Charger les utilisateurs depuis Firestore
      async function chargerUtilisateurs() {
        try {
          const snapshot = await firebase
            .firestore()
            .collection("utilisateurs")
            .get();
          utilisateurs = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            utilisateurs.push({
              id: doc.id,
              identifiant: data.identifiant,
              hash: data.hash,
              role: data.role,
              nom: data.nom || data.identifiant,
              actif: data.actif !== false, // Par défaut actif si pas spécifié
            });
          });
          console.log(`${utilisateurs.length} utilisateurs chargés`);
        } catch (error) {
          console.error("Erreur chargement utilisateurs:", error);
          // Fallback vers la liste codée en dur si Firestore échoue
          utilisateurs = [
            {
              identifiant: "sr01",
              hash: "a33802b00823b82ec5d36a4c7e3e4e9d564ae876bdf5fbec2bf95c226b300fbf",
              role: "admin",
            },
            {
              identifiant: "md160",
              hash: "e14545873d8208c268e7eda0139eae47d529df268b5fbd29f939a0b84f141ffb",
              role: "admin",
            },
            {
              identifiant: "jj04",
              hash: "43240c83a9dde73c4d1ade49baf8196e7e21ead82a3df9f1a40c50595298bcfc",
              role: "user",
            },
          ];
        }
      }

      // Charger les utilisateurs au démarrage
      chargerUtilisateurs();

      const remember = localStorage.getItem("rememberTransportelz");
      const storedRole = localStorage.getItem("roleTransportelz");
      if (remember === "true" && storedRole) {
        window.location.href = "/linktree.html";
      }

      document
        .getElementById("loginForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          verifierConnexion();
        });

      async function hacherTexte(texte) {
        const encoder = new TextEncoder();
        const data = encoder.encode(texte);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
      }

      async function verifierConnexion() {
        const identifiant = document
          .getElementById("identifiant")
          .value.toLowerCase();
        const motdepasse = document
          .getElementById("motdepasse")
          .value.toLowerCase(); // ignore la casse ici
        const rememberMe = document.getElementById("rememberMe").checked;
        const erreur = document.getElementById("erreur");

        // Attendre que les utilisateurs soient chargés
        if (utilisateurs.length === 0) {
          await chargerUtilisateurs();
        }

        const utilisateur = utilisateurs.find(
          (u) => u.identifiant.toLowerCase() === identifiant
        );
        if (!utilisateur) {
          erreur.textContent = "Informations incorrectes.";
          return;
        }

        // Vérifier si l'utilisateur est actif
        if (utilisateur.actif === false) {
          erreur.textContent = "Compte désactivé. Contactez l'administrateur.";
          return;
        }

        const hashEntre = await hacherTexte(motdepasse);
        if (hashEntre === utilisateur.hash) {
          // Toujours sauvegarder les données de session
          localStorage.setItem(
            "rememberTransportelz",
            rememberMe ? "true" : "false"
          );
          localStorage.setItem("roleTransportelz", utilisateur.role);
          localStorage.setItem(
            "identifiantTransportelz",
            utilisateur.identifiant
          );
          localStorage.setItem("nomTransportelz", utilisateur.nom);

          window.location.href = "/linktree.html";
        } else {
          erreur.textContent = "Informations incorrectes.";
        }
      }
    </script>
  </body>
</html>
