<!DOCTYPE html>
<html lang="fr">
  <head>
    <!-- Protection d'authentification - doit √™tre charg√© en premier -->
    <script src="assets/auth-check.js"></script>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sommaire</title>
    <style>
      html,
      body {
        margin: 0;
        padding-top: calc(60px + env(safe-area-inset-top));
        font-family: "Segoe UI", sans-serif;
        background-color: #f4f4f4;
        font-size: 16px;
      }
      /* En-t√™te */
      header {
        background-color: #111;
        width: 100%;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-sizing: border-box;
        z-index: 1000;
      }
      header img {
        height: 40px;
      }

      /* Container et tableau */
      .container {
        padding: 20px;
        max-width: 1000px;
        margin: auto;
      }
      .top-bar {
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
      }
      .top-bar input[type="date"] {
        padding: 8px 12px;
        font-size: 16px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }
      textarea {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        resize: vertical;
        box-sizing: border-box;
        font-size: 15px;
      }
      .table-wrapper {
        overflow-x: auto;
        margin-top: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #999;
        text-align: center;
        vertical-align: middle;
        padding: 6px;
      }
      th {
        background-color: #d32f2f;
        color: white;
        font-weight: bold;
        text-transform: uppercase;
      }
      tr:nth-child(even) td {
        background-color: #f7f7f7;
      }
      tr:nth-child(odd) td {
        background-color: #ffffff;
      }
      td[contenteditable] {
        outline: none;
        text-transform: uppercase;
      }

      /* Boutons */
      .buttons {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .buttons button {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
      }
      .reset-btn {
        background-color: #e74c3c;
      }
      .save-btn {
        background-color: #2ecc71;
      }
      .send-btn {
        background-color: black;
      }
      .copy-btn {
        font-size: 12px;
        padding: 3px 6px;
        background-color: #555;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .copy-btn:hover {
        background-color: #333;
      }
      .arrow-next {
        position: absolute;
        z-index: 1000;
        display: none;
        padding: 2px 6px;
        font-size: 14px;
        border-radius: 6px;
        background: #111;
        color: #fff;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      #garageTable td {
        min-height: 44px;
        height: 44px;
      }
      /* Responsive */
      @media (max-width: 600px) {
        .container {
          padding: 12px;
        }
        .buttons {
          margin-bottom: 40px;
        }
        table {
          font-size: 13px;
        }
        th,
        td {
          padding: 6px;
          height: 32px;
          font-size: 14px;
        }
      }

      td[contenteditable],
      textarea,
      input {
        font-size: 16px !important;
        touch-action: manipulation;
      }

      #garageTable {
        table-layout: fixed;
        width: 100%;
        max-width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      #garageTable th,
      #garageTable td {
        padding: 4px;
        height: 34px; /* plus bas */
        font-size: 13px;
        text-align: center;
        word-break: break-word;
      }

      #garageTable th:first-child,
      #garageTable td:first-child {
        width: 30%;
      }

      #garageTable th:last-child,
      #garageTable td:last-child {
        width: 70%;
      }

      @media (max-width: 600px) {
        #garageTable th,
        #garageTable td {
          font-size: 13px;
          padding: 6px;
        }
      }

      #dispoTable {
        min-width: 900px;
      }

      .load-btn {
        background-color: #f1c40f;
        color: black;
      }
    </style>
    <!-- Firebase SDKs en mode compat pour HTML classique -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyD4U85mokKXsAP1AdwClWtcbt8udZrwlAw",
        authDomain: "sommaireelz.firebaseapp.com",
        projectId: "sommaireelz",
        storageBucket: "sommaireelz.firebasestorage.app",
        messagingSenderId: "171788284751",
        appId: "1:171788284751:web:694f070d1cafe8b7c04b3a",
      };

      // Initialisation Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      window.saveToFirebase = function (data, callback) {
        const collection = db.collection("disponibilites");
        const TWO_YEARS_AGO = new Date();
        TWO_YEARS_AGO.setFullYear(TWO_YEARS_AGO.getFullYear() - 2);

        collection
          .where("timestamp", "<", TWO_YEARS_AGO.toISOString())
          .get()
          .then((snapshot) => {
            const deletions = snapshot.docs.map((doc) => doc.ref.delete());
            return Promise.all(deletions);
          })
          .then(() => {
            return collection.where("date", "==", data.date).get();
          })
          .then((snapshot) => {
            if (!snapshot.empty) {
              const existingDocId = snapshot.docs[0].id;
              return collection.doc(existingDocId).set(data, { merge: false });
            } else {
              return collection.add(data);
            }
          })
          .then(() => {
            console.log("‚úÖ Donn√©es sauvegard√©es (ajout ou mise √† jour).");
            if (typeof callback === "function") callback();
          })
          .catch((error) => {
            console.error("‚ùå Erreur Firebase :", error);
            alert("Erreur d‚Äôenregistrement Firebase : " + error.message);
          });
      };

      // Variable pour suivre la derni√®re date charg√©e (protection contre les race conditions)
      let lastLoadedDate = null;
      
      window.loadFromFirebase = function (date) {
        // Mettre √† jour la date actuelle imm√©diatement pour √©viter les sauvegardes avec la mauvaise date
        if (typeof window.updateCurrentDate === 'function') {
          window.updateCurrentDate(date);
        }
        lastLoadedDate = date;
        
        db.collection("disponibilites")
          .where("date", "==", date)
          .orderBy("timestamp", "desc")
          .limit(1)
          .get()
          .then((querySnapshot) => {
            // V√©rifier que la date n'a pas chang√© pendant le chargement
            if (lastLoadedDate !== date) {
              console.log("‚ö†Ô∏è Date a chang√© pendant le chargement, annulation");
              return;
            }
            if (!querySnapshot.empty) {
              const data = querySnapshot.docs[0].data();

              // Injecte les donn√©es dans les tables
              const garageBody = document.getElementById("garageBody");
              garageBody.innerHTML = "";
              (data.garage || []).forEach((item) => {
                const tr = createGarageRow();
                const cells = tr.querySelectorAll("td");
                cells[0].textContent = item.unite || "";
                cells[1].textContent = item.raison || "";
                garageBody.appendChild(tr);
              });

              elements.noteField.value = data.note || "";
              elements.dateSelect.value = data.date || "";
              elements.tableBody.innerHTML = "";

              data.rows.forEach((row) => {
                const tr = createRow();
                const cells = tr.querySelectorAll("td");
                cells[0].textContent = row.rang || "";
                cells[1].textContent = row.client || "";
                cells[2].textContent = row.type || "";
                cells[3].textContent = row.depart || "";
                cells[4].textContent = row.livraison || "";
                cells[5].textContent = row.chauffeur || "";
                cells[6].textContent = row.camion || "";
                cells[7].textContent = row.remorque || "";
                elements.tableBody.appendChild(tr);
              });

              // Mettre √† jour currentDate apr√®s le chargement
              if (typeof window.updateCurrentDate === 'function') {
                window.updateCurrentDate(data.date || "");
              }

              // V√©rifier √† nouveau que la date n'a pas chang√©
              if (lastLoadedDate !== date) {
                console.log("‚ö†Ô∏è Date a chang√© pendant le chargement, annulation");
                return;
              }
              
              console.log("‚úÖ Donn√©es charg√©es depuis Firebase !");
            } else {
              // V√©rifier que la date n'a pas chang√© pendant le chargement
              if (lastLoadedDate !== date) {
                console.log("‚ö†Ô∏è Date a chang√© pendant le chargement, annulation");
                return;
              }
              
              console.log(
                "üì≠ Aucune donn√©e trouv√©e dans Firebase. R√©initialisation..."
              );

              // R√©initialise le tableau (efface tout sauf la colonne rang, colonne copie et derni√®re ligne + avant-derni√®re ligne)
              elements.noteField.value = "";
              const rows = document.querySelectorAll("#tableBody tr");
              rows.forEach((row, index) => {
                // Ne pas toucher √† la derni√®re ligne ni √† l'avant-derni√®re ligne
                if (index === rows.length - 1 || index === rows.length - 2) return;
                const cells = row.querySelectorAll("td");
                // Effacer de l'index 1 √† 7 (sauf la colonne COPIE qui est √† l'index 8)
                for (let i = 1; i < 8; i++) {
                  if (cells[i]) cells[i].textContent = "";
                }
                // Ne pas effacer l'index 8 (COPIE) ni l'index 9 (checkbox)
              });
              db.collection("disponibilites")
                .orderBy("timestamp", "desc")
                .limit(1)
                .get()
                .then((snapshot) => {
                  const garageBody = document.getElementById("garageBody");
                  garageBody.innerHTML = "";

                  if (!snapshot.empty) {
                    const lastData = snapshot.docs[0].data();
                    const lastGarage = Array.isArray(lastData.garage)
                      ? lastData.garage
                      : [];

                    for (let i = 0; i < 3; i++) {
                      const tr = createGarageRow();
                      const cells = tr.querySelectorAll("td");

                      if (lastGarage[i]) {
                        cells[0].textContent = lastGarage[i].unite || "";
                        cells[1].textContent = lastGarage[i].raison || "";
                      }

                      garageBody.appendChild(tr);
                    }
                  } else {
                    // Aucune sauvegarde garage trouv√©e ‚Üí on g√©n√®re 3 lignes vides
                    generateGarageRows(3);
                  }
                  
                  // V√©rifier que la date n'a pas chang√© avant de mettre √† jour
                  if (lastLoadedDate === date) {
                    // Mettre √† jour currentDate apr√®s le reset
                    if (typeof window.updateCurrentDate === 'function') {
                      window.updateCurrentDate(date || "");
                    }
                  }
                });
            }
          })
          .catch((error) => {
            console.error("‚ùå Erreur Firebase :", error);
            // En cas d'erreur, s'assurer que currentDate est quand m√™me mise √† jour si la date n'a pas chang√©
            if (lastLoadedDate === date && typeof window.updateCurrentDate === 'function') {
              window.updateCurrentDate(date || "");
            }
          });
      };
    </script>
  </head>
  <body>
    <div id="customHeader"></div>
    <script src="assets/header-loader.js"></script>
    <div class="container">
      <div class="top-bar">
        <input type="date" id="dateSelect" />
      </div>
      <label for="note">Note:</label>
      <textarea id="note" rows="2"></textarea>
      <div class="table-wrapper">
        <table id="dispoTable">
          <thead>
            <tr>
              <th style="width: 70px">RANG</th>
              <th style="width: 200px">CLIENT</th>
              <th style="width: 80px">TYPE</th>
              <th style="width: 80px">D√âPART</th>
              <th style="width: 80px">LIVRS</th>
              <th style="width: 100px">CHAUF</th>
              <th style="width: 90px">CAMION</th>
              <th style="width: 100px">REMORQUE</th>
              <th style="width: 60px">COPIE</th>
              <th style="width: 50px">‚úÖ</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <h3 style="text-align: center; font-size: 18px">üõ†Ô∏è Unit√©s au garage</h3>
      <div class="table-wrapper">
        <table id="garageTable">
          <thead>
            <tr>
              <th style="width: 30%">UNIT√â</th>
              <th style="width: 70%">RAISON</th>
            </tr>
          </thead>
          <tbody id="garageBody">
            <tr>
              <td contenteditable style="height: 36px"></td>
              <td contenteditable style="height: 36px"></td>
            </tr>
            <tr>
              <td contenteditable style="height: 36px"></td>
              <td contenteditable style="height: 36px"></td>
            </tr>
            <tr>
              <td contenteditable style="height: 36px"></td>
              <td contenteditable style="height: 36px"></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="buttons" style="margin-top: 16px">
        <button class="reset-btn" id="resetBtn">Reset</button>
        <button class="load-btn" id="copySelectedBtn">Copie</button>
        <button class="send-btn" id="sendBtn">Send</button>
      </div>
    </div>

    <script>
      // Configuration et constantes
      const API_URL =
        "https://script.google.com/macros/s/AKfycbzrfDI9G0SfnA1S_OYhUqZhmXQEhfViuHkWGYUibGtzlF1KkPtvLNKK-DhruNy7uGeR/exec";
      const CHAUFFEUR_MAP = {
        JFJ: { nom: "Jeff", tel: "4185202502" },
        AL: { nom: "Alain", tel: "4182710206" },
        PF: { nom: "Patrick", tel: "4185696346" },
        RPE: { nom: "Rraymond", tel: "4186706104" },
        CYR: { nom: "Clement", tel: "5819223336" },
        BPQ: { nom: "Benoit", tel: "5819933470" },
        RED: { nom: "Rejean", tel: "4183254436" },
        SIR: { nom: "Simon", tel: "4185760436" },
        AC: { nom: "Alain", tel: "4182843106" },
        CEM: { nom: "Charles-√âtienne", tel: "5819892459" },
      };
      const STORAGE_KEYS = {
        note: "dispo_note",
        date: "dispo_date",
        rows: "dispo_rows",
      };
      const DAYS_FR = [
        "Dimanche",
        "Lundi",
        "Mardi",
        "Mercredi",
        "Jeudi",
        "Vendredi",
        "Samedi",
      ];
      const MONTHS_FR = [
        "janvier",
        "f√©vrier",
        "mars",
        "avril",
        "mai",
        "juin",
        "juillet",
        "ao√ªt",
        "septembre",
        "octobre",
        "novembre",
        "d√©cembre",
      ];

      // √âl√©ments DOM
      const elements = {
        dateSelect: document.getElementById("dateSelect"),
        noteField: document.getElementById("note"),
        tableBody: document.getElementById("tableBody"),
        dispoTable: document.getElementById("dispoTable"),
        resetBtn: document.getElementById("resetBtn"),
        copySelectedBtn: document.getElementById("copySelectedBtn"),
        sendBtn: document.getElementById("sendBtn"),
      };

      function createGarageRow() {
        const tr = document.createElement("tr");
        tr.innerHTML = `
    <td contenteditable></td>
    <td contenteditable></td>
  `;
        return tr;
      }

      function generateGarageRows(n = 3) {
        const garageBody = document.getElementById("garageBody");
        garageBody.innerHTML = "";
        for (let i = 0; i < n; i++) {
          garageBody.appendChild(createGarageRow());
        }
      }

      // Fonctions pour la gestion des lignes du tableau
      function createRow() {
        const row = document.createElement("tr");
        row.innerHTML = `
        <td contenteditable inputmode="numeric"></td>
        <td contenteditable></td>
        <td contenteditable></td>
        <td contenteditable></td>
        <td contenteditable></td>
        <td contenteditable></td>
        <td contenteditable inputmode="numeric"></td>
        <td contenteditable inputmode="numeric"></td>
        <td><button class="copy-btn">üìã</button></td>
        <td><input type="checkbox" class="row-select" /></td>
      `;
        // Attacher l'√©v√©nement directement lors de la cr√©ation
        const copyBtn = row.querySelector(".copy-btn");
        copyBtn.addEventListener("click", () => copyRow(row));
        return row;
      }

      function generateDefaultRows(n = 9) {
        elements.tableBody.innerHTML = "";
        for (let i = 0; i < n; i++) {
          elements.tableBody.appendChild(createRow());
        }
      }

      // Fonctions pour les op√©rations principales
      function formatDate(dateStr) {
        if (!dateStr) return "";

        const [year, month, day] = dateStr.split("-");
        const dateObj = new Date(Number(year), Number(month) - 1, Number(day));

        const dayName = DAYS_FR[dateObj.getDay()];
        const dayNum = dateObj.getDate();
        const monthName = MONTHS_FR[dateObj.getMonth()];

        return `${dayName} le ${dayNum} ${monthName}`;
      }

      function copyRow(row) {
        const cells = row.querySelectorAll("td");

        const rawCode = (cells[5]?.textContent || "").trim().toUpperCase();
        const chauffeur = CHAUFFEUR_MAP[rawCode] || { nom: rawCode, tel: "" };

        const values = [
          chauffeur.nom,
          (cells[1]?.textContent || "").trim().toUpperCase(),
          (cells[2]?.textContent || "").trim().toUpperCase(),
          (cells[3]?.textContent || "").trim().toUpperCase(),
          (cells[4]?.textContent || "").trim().toUpperCase(),
          (cells[6]?.textContent || "").trim().toUpperCase(),
          (cells[7]?.textContent || "").trim().toUpperCase(),
        ];

        const labels = [
          "Chauffeur",
          "Client",
          "Type",
          "D√©part",
          "Livraison",
          "Camion",
          "Remorque",
        ];
        const dayFormatted = formatDate(elements.dateSelect.value);

        let sms = `Salut,\nVoici ton voyage pour ${dayFormatted}\n\n`;
        sms += labels
          .map((label, idx) => `${label}: ${values[idx]}`)
          .join("\n");
        sms += `\n\nMerci !`;

        const smsEncoded = encodeURIComponent(sms);
        const href = chauffeur.tel
          ? `sms:${chauffeur.tel}?body=${smsEncoded}`
          : `sms:?body=${smsEncoded}`;

        // Cr√©ation et clic du lien
        const link = document.createElement("a");
        link.href = href;
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      function resetForm() {
        elements.noteField.value = "";
        // Ne pas r√©initialiser le date picker
        localStorage.clear();

        const rows = document.querySelectorAll("#tableBody tr");
        rows.forEach((row, index) => {
          // Si c'est l'une des deux derni√®res lignes, on la saute
          if (index === rows.length - 1 || index === rows.length - 2) return;

          const cells = row.querySelectorAll("td");
          // Ne pas effacer la 1re cellule (rang)
          for (let i = 1; i < 8; i++) {
            if (cells[i]) cells[i].textContent = "";
          }
        });
        
        // Sauvegarder apr√®s le reset pour que les changements soient persist√©s
        // Seulement si une date est s√©lectionn√©e
        if (elements.dateSelect.value) {
          setTimeout(() => {
            saveData(true); // Sauvegarde silencieuse apr√®s reset
          }, 100);
        }
      }

      function saveData(silent = false) {
        try {
          // Capturer la date au d√©but pour v√©rifier qu'elle n'a pas chang√©
          const dateAtStart = elements.dateSelect.value;
          
          // V√©rifier qu'une date est s√©lectionn√©e
          if (!dateAtStart || dateAtStart.trim() === "") {
            if (!silent) {
              console.warn("‚ö†Ô∏è Impossible de sauvegarder : aucune date s√©lectionn√©e");
            }
            return;
          }

          const note = elements.noteField.value;
          const rows = Array.from(
            document.querySelectorAll("#dispoTable tbody tr")
          ).map((tr) => {
            const cells = Array.from(tr.querySelectorAll("td")).slice(0, 8);
            return {
              rang: cells[0]?.textContent.trim() || "",
              client: cells[1]?.textContent.trim() || "",
              type: cells[2]?.textContent.trim() || "",
              depart: cells[3]?.textContent.trim() || "",
              livraison: cells[4]?.textContent.trim() || "",
              chauffeur: cells[5]?.textContent.trim() || "",
              camion: cells[6]?.textContent.trim() || "",
              remorque: cells[7]?.textContent.trim() || "",
            };
          });

          const garageRows = Array.from(
            document.querySelectorAll("#garageTable tbody tr")
          ).map((tr) => {
            const tds = tr.querySelectorAll("td");
            return {
              unite: tds[0]?.textContent.trim() || "",
              raison: tds[1]?.textContent.trim() || "",
            };
          });

          // V√©rifier que la date n'a pas chang√© pendant la pr√©paration des donn√©es
          const dateAtEnd = elements.dateSelect.value;
          if (dateAtStart !== dateAtEnd) {
            if (!silent) {
              console.warn("‚ö†Ô∏è Date a chang√© pendant la sauvegarde, annulation");
            }
            return;
          }

          const data = {
            note,
            date: dateAtStart,
            rows,
            garage: garageRows,
            timestamp: new Date().toISOString(),
          };

          localStorage.setItem("garage_rows", JSON.stringify(garageRows));
          localStorage.setItem(STORAGE_KEYS.note, note);
          localStorage.setItem(STORAGE_KEYS.date, dateAtStart);
          localStorage.setItem(STORAGE_KEYS.rows, JSON.stringify(rows));

          if (window.saveToFirebase) {
            window.saveToFirebase(data, () => {
              if (!silent) {
                alert("‚úÖ Donn√©es sauvegard√©es localement ET dans Firebase !");
              }
            });
          }
        } catch (err) {
          if (!silent) {
            alert("Erreur lors de la sauvegarde : " + err.message);
          } else {
            console.error("Erreur lors de la sauvegarde :", err);
          }
        }
      }

      function sendForm() {
        const tableClone = document
          .getElementById("dispoTable")
          .cloneNode(true);
        const rows = tableClone.querySelectorAll("tbody tr");

        rows.forEach((row) => {
          const cells = row.querySelectorAll("td");
          let isRowEmpty = true;

          for (let i = 0; i < cells.length; i++) {
            if (i >= 8) continue; // Skip the copy button and checkbox cells
            const text = cells[i]?.innerText?.trim();
            if (text) {
              isRowEmpty = false;
              break;
            }
          }

          for (let i = 0; i < cells.length; i++) {
            const cell = cells[i];

            if (i >= 8) {
              // Handle the copy button and checkbox cells
              cell.innerHTML = ""; // Remove interactive elements
            } else if (cell.hasAttribute("contenteditable")) {
              cell.innerText = cell.innerText.trim().toUpperCase();
            }
          }
        });

        const selectedDate = document.querySelector("#dateSelect")?.value || "";
        if (!selectedDate) {
          alert("Veuillez s√©lectionner une date.");
          return;
        }
        const data = {
          note: document.getElementById("note").value,
          date: selectedDate,
          table: tableClone.outerHTML,
        };

        fetch(
          "https://script.google.com/macros/s/AKfycbzrfDI9G0SfnA1S_OYhUqZhmXQEhfViuHkWGYUibGtzlF1KkPtvLNKK-DhruNy7uGeR/exec",
          {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          }
        );

        alert("Sommaire envoy√© !");
      }

      function copySelectedLines() {
        const rows = Array.from(document.querySelectorAll("#tableBody tr"));
        const lines = [];
        rows.forEach((row) => {
          const checkbox = row.querySelector("input.row-select");
          if (checkbox && checkbox.checked) {
            const cells = row.querySelectorAll("td");
            const client = (cells[1]?.textContent || "").trim().toUpperCase();
            const livrs = (cells[4]?.textContent || "").trim().toUpperCase();
            if (client || livrs) {
              lines.push(`${client} ${livrs}`.trim());
            }
          }
        });
        const text = lines.join("\n");
        if (!text) {
          alert("Aucune ligne s√©lectionn√©e.");
          return;
        }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).then(
            () => alert("Lignes copi√©es dans le presse-papiers."),
            () => fallbackCopyText(text)
          );
        } else {
          fallbackCopyText(text);
        }
      }

      function fallbackCopyText(text) {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.opacity = "0";
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand("copy");
          alert("Lignes copi√©es dans le presse-papiers.");
        } catch (e) {
          alert("Impossible de copier.");
        }
        document.body.removeChild(ta);
      }

      // Gestion de la navigation avec fl√®che
      function setupArrowNavigation() {
        const arrowBtn = document.createElement("button");
        arrowBtn.textContent = "‚û°Ô∏è";
        arrowBtn.className = "arrow-next";
        document.body.appendChild(arrowBtn);

        let currentCell = null;

        // Fonction pour mettre √† jour la position du bouton fl√®che
        function updateArrowPosition() {
          if (!currentCell) return;
          const rect = currentCell.getBoundingClientRect();
          arrowBtn.style.top = `${window.scrollY + rect.top + 5}px`;
          arrowBtn.style.left = `${window.scrollX + rect.right + 5}px`;
          arrowBtn.style.display = "inline-block";
        }

        // D√©placement vers la cellule suivante
        function moveToNextCell() {
          if (!currentCell) return;
          const row = currentCell.closest("tr");
          const cells = Array.from(row.querySelectorAll("td[contenteditable]"));
          const idx = cells.indexOf(currentCell);

          let next = null;

          if (idx < cells.length - 1) {
            next = cells[idx + 1];
          } else {
            const nextRow = row.nextElementSibling;
            if (nextRow) {
              const nextCells = Array.from(
                nextRow.querySelectorAll("td[contenteditable]")
              );
              if (nextCells.length) next = nextCells[0];
            }
          }

          if (next) {
            next.focus();
            currentCell = next;

            // Attendre le rendu avant scroll
            setTimeout(() => {
              next.scrollIntoView({
                behavior: "smooth",
                block: "nearest",
                inline: "center",
              });
              updateArrowPosition();
            }, 50);
          }
        }

        // √âv√©nements
        elements.dispoTable.addEventListener("focusin", (e) => {
          if (
            e.target.tagName === "TD" &&
            e.target.hasAttribute("contenteditable")
          ) {
            currentCell = e.target;
            updateArrowPosition();

            // Assurer que la cellule est visible
            currentCell.scrollIntoView({
              behavior: "smooth",
              block: "nearest",
              inline: "center",
            });
          }
        });

        document.addEventListener("scroll", updateArrowPosition);

        arrowBtn.addEventListener("click", moveToNextCell);

        document.addEventListener("click", (e) => {
          if (!e.target.closest("td") && e.target !== arrowBtn) {
            arrowBtn.style.display = "none";
            currentCell = null;
          }
        });
      }

      // √âv√©nement pour convertir le texte en majuscules pendant la saisie
      document.addEventListener("input", (e) => {
        if (e.target.matches("td[contenteditable]")) {
          const selection = window.getSelection();
          const range = selection.getRangeAt(0);
          const cursorPos = range.startOffset;

          const upper = e.target.textContent.toUpperCase();
          e.target.textContent = upper;

          // Remet le curseur √† la bonne place
          if (e.target.firstChild) {
            range.setStart(
              e.target.firstChild,
              Math.min(cursorPos, e.target.textContent.length)
            );
            range.setEnd(
              e.target.firstChild,
              Math.min(cursorPos, e.target.textContent.length)
            );
            selection.removeAllRanges();
            selection.addRange(range);
          }
        }
      });

      function init() {
        elements.resetBtn.addEventListener("click", resetForm);
        elements.copySelectedBtn.addEventListener("click", copySelectedLines);
        elements.sendBtn.addEventListener("click", sendForm);
        elements.dateSelect.addEventListener("change", () => {
          const selectedDate = elements.dateSelect.value;
          if (!selectedDate) return;
          window.loadFromFirebase(selectedDate);
        });

        elements.tableBody.innerHTML = "";

        // üöÄ Toujours charger la derni√®re entr√©e Firebase (peu importe localStorage)
        db.collection("disponibilites")
          .orderBy("timestamp", "desc")
          .limit(1)
          .get()
          .then((snapshot) => {
            if (!snapshot.empty) {
              const data = snapshot.docs[0].data();
              elements.dateSelect.value = data.date || "";
              elements.noteField.value = data.note || "";

              if (Array.isArray(data.rows) && data.rows.length > 0) {
                data.rows.forEach((row) => {
                  const tr = createRow();
                  const cells = tr.querySelectorAll("td");
                  cells[0].textContent = row.rang || "";
                  cells[1].textContent = row.client || "";
                  cells[2].textContent = row.type || "";
                  cells[3].textContent = row.depart || "";
                  cells[4].textContent = row.livraison || "";
                  cells[5].textContent = row.chauffeur || "";
                  cells[6].textContent = row.camion || "";
                  cells[7].textContent = row.remorque || "";
                  elements.tableBody.appendChild(tr);
                });
              } else {
                generateDefaultRows(9);
              }

              const garageBody = document.getElementById("garageBody");
              garageBody.innerHTML = "";

              if (Array.isArray(data.garage) && data.garage.length > 0) {
                data.garage.forEach((item) => {
                  const tr = createGarageRow();
                  const cells = tr.querySelectorAll("td");
                  cells[0].textContent = item.unite || "";
                  cells[1].textContent = item.raison || "";
                  garageBody.appendChild(tr);
                });
              } else {
                generateGarageRows(3);
              }

              localStorage.setItem(STORAGE_KEYS.note, data.note || "");
              localStorage.setItem(STORAGE_KEYS.date, data.date || "");
              localStorage.setItem(
                STORAGE_KEYS.rows,
                JSON.stringify(data.rows || [])
              );

              // Mettre √† jour currentDate apr√®s le chargement
              if (typeof window.updateCurrentDate === 'function') {
                window.updateCurrentDate(data.date || "");
              }

              console.log("üü¢ Donn√©es charg√©es depuis Firebase.");
            } else {
              console.log(
                "üì≠ Aucune donn√©e trouv√©e dans Firebase. R√©initialisation cibl√©e."
              );

              elements.noteField.value = "";
              const rows = document.querySelectorAll("#tableBody tr");

              rows.forEach((row, index) => {
                const cells = row.querySelectorAll("td");
                // Ne pas toucher √† la derni√®re ligne ni √† l'avant-derni√®re ligne
                if (index === rows.length - 1 || index === rows.length - 2) return;

                // Effacer de l'index 1 √† 7 (sauf la colonne COPIE qui est √† l'index 8)
                for (let i = 1; i < 8; i++) {
                  if (cells[i]) cells[i].textContent = "";
                }
                // Ne pas effacer l'index 8 (COPIE) ni l'index 9 (checkbox)
              });

              generateGarageRows(3);
              
              // Mettre √† jour currentDate m√™me si aucune donn√©e
              const dateFromSelect = elements.dateSelect.value;
              if (typeof window.updateCurrentDate === 'function') {
                window.updateCurrentDate(dateFromSelect || "");
              }
            }
          });
        // setupArrowNavigation(); // D√©sactiv√© - fl√®che visuelle retir√©e
      }

      // ---------- D√âBUT : Autosave Firebase (debounce + fin de mot) ----------
      (function () {
        const DEBOUNCE_MS = 2000; // d√©lai apr√®s la derni√®re frappe avant sauvegarde (si pas d'espace)
        const MIN_SAVE_INTERVAL = 3000; // intervalle minimal entre 2 saves pour √©viter spams
        let debounceTimer = null;
        let lastSaveAt = 0;
        let isSaving = false;
        let hasPendingChange = false; // Flag pour suivre si une modification est en cours
        let currentDate = ""; // Suivre la date actuelle pour √©viter les sauvegardes avec la mauvaise date
        let isChangingDate = false; // Flag pour indiquer qu'on est en train de changer de date

        function now() {
          return Date.now();
        }

        function canSaveNow() {
          return now() - lastSaveAt > MIN_SAVE_INTERVAL;
        }

        // wrapper qui √©vite les sauvegardes trop rapproch√©es
        function doAutoSave(reason) {
          // Ne pas sauvegarder si on est en train de changer de date
          if (isChangingDate) {
            console.log("Autosave annul√©e : changement de date en cours");
            return;
          }
          
          // V√©rifier que la date actuelle correspond √† celle qu'on veut sauvegarder
          const dateInput = elements.dateSelect;
          const dateValue = dateInput ? dateInput.value : "";
          if (dateValue && dateValue !== currentDate) {
            console.log("Autosave annul√©e : date a chang√© pendant la sauvegarde");
            return;
          }
          
          if (!canSaveNow() || isSaving) {
            // si trop proche ou d√©j√† en train de sauvegarder, on annule/repousse
            clearTimeout(debounceTimer);
            if (!isSaving) {
              debounceTimer = setTimeout(
                () => doAutoSave(reason),
                MIN_SAVE_INTERVAL
              );
            }
            return;
          }
          isSaving = true;
          lastSaveAt = now();
          // utilise la fonction existante saveData() pour construire + faire localStorage + call firebase
          try {
            saveData(true); // saveData avec silent=true pour √©viter les popups
            console.log("Autosave Firebase d√©clench√©e ->", reason || "auto");
            // R√©initialiser le flag apr√®s un court d√©lai
            setTimeout(() => {
              isSaving = false;
            }, 500);
          } catch (err) {
            console.error("Autosave erreur:", err);
            isSaving = false;
          }
        }

        // √©v√©nement "intelligent" sur saisie : sauvegarde imm√©diatement si fin de mot (espace/entr√©e)
        function onEditableInput(e) {
          // e.data peut √™tre null selon le navigateur; on v√©rifie la pr√©sence d'un ' ' dans la derni√®re insertion
          const target = e.target;
          // ignore si ce n'est pas un champ √©ditable que nous voulons surveiller
          if (!target) return;

          // r√©initialise debounce
          clearTimeout(debounceTimer);
          hasPendingChange = true; // Marque qu'une modification est en cours

          // si l'input contient un espace en fin (ou si l'inputEvent signale 'insertParagraph'), on sauvegarde tout de suite
          const text = (target.innerText || target.value || "").trimEnd();
          const lastChar = text.length > 0 ? text[text.length - 1] : "";
          const inputIsSpace =
            (e.inputType &&
              (e.inputType === "insertParagraph" ||
                e.inputType === "insertLineBreak")) ||
            lastChar === " ";

          if (inputIsSpace || e.inputType === "insertFromPaste") {
            // sauvegarde imm√©diate (fin de mot ou collage)
            hasPendingChange = false; // Reset car on sauvegarde imm√©diatement
            doAutoSave("fin de mot / saut de ligne / collage");
          } else {
            // debounce : attend pause de frappe
            debounceTimer = setTimeout(() => {
              hasPendingChange = false; // Reset apr√®s sauvegarde
              doAutoSave("pause frappe");
            }, DEBOUNCE_MS);
          }
        }

        // Sur certains navigateurs, keyup fournit mieux la d√©tection de 'espace' et 'Entr√©e'
        // NOTE: on ne d√©clenche pas de sauvegarde ici car input() le fera d√©j√†
        // Cela √©vite les double sauvegardes
        function onEditableKeyup(e) {
          // La sauvegarde sera g√©r√©e par onEditableInput
        }

        // On sauvegarde aussi √† la sortie du champ (blur) - SEULEMENT si une modification √©tait en cours
        function onEditableBlur(e) {
          // Sauvegarde seulement s'il y a eu une modification d√©tect√©e
          if (hasPendingChange || debounceTimer !== null) {
            clearTimeout(debounceTimer);
            debounceTimer = null;
            hasPendingChange = false;
            setTimeout(() => doAutoSave("blur"), 80);
          }
          // Sinon, aucune sauvegarde - la cellule a juste √©t√© s√©lectionn√©e sans modification
        }

        // Sur changement de date -> annuler l'autosave en cours et mettre √† jour la date
        function onDateChange(e) {
          // Annuler tout autosave en cours
          clearTimeout(debounceTimer);
          debounceTimer = null;
          hasPendingChange = false;
          isChangingDate = true;
          
          // Mettre √† jour la date actuelle apr√®s un court d√©lai pour laisser le temps au changement de se faire
          setTimeout(() => {
            const dateInput = elements.dateSelect;
            if (dateInput) {
              currentDate = dateInput.value || "";
            }
            isChangingDate = false;
          }, 200);
        }

        function attachAutosaveListeners() {
          // textarea note
          const note = document.getElementById("note");
          if (note) {
            note.addEventListener("input", onEditableInput);
            note.addEventListener("keyup", onEditableKeyup);
            note.addEventListener("blur", onEditableBlur);
          }

          // cellules contenteditable du tableau (dynamique) : on surveille le container et on d√©l√®gue
          const table = document.getElementById("dispoTable");
          if (table) {
            // D√©l√©gation d'√©v√©nement : input/keyup/blur sur les TD contenteditable
            table.addEventListener("input", function (e) {
              if (e.target && e.target.matches("td[contenteditable]"))
                onEditableInput(e);
            });
            table.addEventListener(
              "keyup",
              function (e) {
                if (e.target && e.target.matches("td[contenteditable]"))
                  onEditableKeyup(e);
              },
              true
            );
            table.addEventListener(
              "focusout",
              function (e) {
                if (e.target && e.target.matches("td[contenteditable]"))
                  onEditableBlur(e);
              },
              true
            );
          }

          // garageTable contenteditable fields
          const garage = document.getElementById("garageTable");
          if (garage) {
            garage.addEventListener("input", function (e) {
              if (e.target && e.target.matches("td[contenteditable]"))
                onEditableInput(e);
            });
            garage.addEventListener(
              "keyup",
              function (e) {
                if (e.target && e.target.matches("td[contenteditable]"))
                  onEditableKeyup(e);
              },
              true
            );
            garage.addEventListener(
              "focusout",
              function (e) {
                if (e.target && e.target.matches("td[contenteditable]"))
                  onEditableBlur(e);
              },
              true
            );
          }

          // date change
          const dateSelect = document.getElementById("dateSelect");
          if (dateSelect) {
            dateSelect.addEventListener("change", onDateChange);
            // Initialiser currentDate avec la date actuelle
            currentDate = dateSelect.value || "";
          }

          // sauvegarde lorsque l'utilisateur quitte la page (s√©curit√©)
          window.addEventListener("beforeunload", function () {
            // on force un petit sync save via saveData (sans alert) : √ßa sauvera en localStorage et tentera firebase
            try {
              saveData(true);
            } catch (e) {
              /* silent */
            }
          });

          // Exposer une fonction pour mettre √† jour currentDate depuis l'ext√©rieur
          window.updateCurrentDate = function(newDate) {
            currentDate = newDate || "";
            isChangingDate = false;
          };

          console.log("Autosave Firebase: listeners attach√©s.");
        }

        // expose pour debug (optionnel)
        window._autosave = {
          attach: attachAutosaveListeners,
          trigger: () => doAutoSave("manuel"),
        };

        // Lorsque la page est initialis√©e, on attache les listeners (init() appellera attach s'il est plac√© apr√®s)
        // Si tu pr√©f√®res l'appeler explicitement dans init(), commente la ligne suivante et appelle window._autosave.attach() dans init().
        // ATTENTION: appeler ici uniquement si le DOM est pr√™t ‚Äî nous v√©rifions existence des √©l√©ments.
        document.addEventListener("DOMContentLoaded", () => {
          // Si init() refait des √©l√©ments dynamiquement, pr√©f√®re l'appel explicite dans init()
          // On v√©rifie si les √©l√©ments existent maintenant
          if (document.getElementById("dispoTable")) {
            attachAutosaveListeners();
          }
        });
      })();
      // ---------- FIN : Autosave Firebase ----------

      // D√©marrer l'application quand la page est charg√©e
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
