<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sommaire</title>
  <style>
    /* Styles de base */
    html, body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f4f4;
      font-size: 16px;
    }

    /* En-t√™te */
    header {
      background-color: #111;
      width: 100%;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-sizing: border-box;
      z-index: 1000;
    }
    header img {
      height: 40px;
    }

    /* Menu hamburger */
    .menu-toggle {
      display: flex;
      flex-direction: column;
      cursor: pointer;
    }
    .menu-toggle span {
      height: 3px;
      width: 25px;
      background: white;
      margin: 4px 0;
      transition: 0.3s;
    }
    .menu {
      display: none;
      position: absolute;
      top: 60px;
      right: 20px;
      background-color: #111;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 10px;
      z-index: 999;
    }
    .menu.show {
      display: block;
    }
    .menu a {
      display: block;
      color: white;
      padding: 8px 12px;
      text-decoration: none;
      font-size: 14px;
    }
    .menu a:hover {
      background-color: #333;
    }

    /* Container et tableau */
    .container {
      padding: 20px;
      max-width: 1000px;
      margin: auto;
    }
    .top-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .top-bar input[type="date"] {
      padding: 8px 12px;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      resize: vertical;
      box-sizing: border-box;
      font-size: 15px;
    }
    .table-wrapper {
      overflow-x: auto;
      margin-top: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    table {
      min-width: 900px;
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #999;
      text-align: center;
      vertical-align: middle;
      padding: 6px;
    }
    th {
      background-color: #d32f2f;
      color: white;
      font-weight: bold;
      text-transform: uppercase;
    }
    tr:nth-child(even) td {
      background-color: #f7f7f7;
    }
    tr:nth-child(odd) td {
      background-color: #ffffff;
    }
    td[contenteditable] {
      outline: none;
      text-transform: uppercase;
    }
    
    /* Style pour les s√©lecteurs de camion/remorque */
    .vehicle-select {
      width: 100%;
      background-color: transparent;
      border: none;
      text-align: center;
      padding: 5px;
      font-family: 'Segoe UI', sans-serif;
      font-size: 15px;
      text-transform: uppercase;
      appearance: none;
      cursor: pointer;
    }
    
    .vehicle-select:focus {
      outline: 1px dashed #999;
    }
    
    .vehicle-select option {
      background-color: white;
    }
    
    td.booked {
      background-color: #ffebee !important;
      position: relative;
    }
    
    td.booked::after {
      content: "‚úì";
      position: absolute;
      top: 0;
      right: 0;
      font-size: 10px;
      background-color: #d32f2f;
      color: white;
      width: 14px;
      height: 14px;
      line-height: 14px;
      text-align: center;
      border-bottom-left-radius: 4px;
    }

    /* Notification style */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 20px;
      background-color: #333;
      color: white;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      z-index: 1100;
      transform: translateY(100px);
      opacity: 0;
      transition: transform 0.3s, opacity 0.3s;
    }
    
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .notification.success {
      background-color: #2ecc71;
    }
    
    .notification.error {
      background-color: #e74c3c;
    }

    /* Boutons */
    .buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .buttons button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
    }
    .reset-btn { background-color: #e74c3c; }
    .save-btn { background-color: #2ecc71; }
    .send-btn { background-color: black; }
    .copy-btn {
      font-size: 12px;
      padding: 3px 6px;
      background-color: #555;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .copy-btn:hover {
      background-color: #333;
    }
    .arrow-next {
      position: absolute;
      z-index: 1000;
      display: none;
      padding: 2px 6px;
      font-size: 14px;
      border-radius: 6px;
      background: #111;
      color: #fff;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container {
        padding: 12px;
      }
      .buttons {
        margin-bottom: 40px;
      }
      table {
        font-size: 13px;
      }
      th, td {
        padding: 6px;
        height: 32px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="assets/logo.jpeg" alt="Logo Transport ELZ">
    <div class="menu-toggle" id="menuToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <div class="menu" id="menuDropdown">
      <a href="dispos.html">Disponibilit√©s</a>
      <a href="linktree.html">Menu</a>
      <a href="camions.html">Camions</a>
      <a href="remorques.html">Remorques</a>
    </div>
  </header>
  <div class="container">
    <div class="top-bar">
      <input type="date" id="dateSelect" />
    </div>
    <label for="note">Note:</label>
    <textarea id="note" rows="2"></textarea>
    <div class="table-wrapper">
      <table id="dispoTable">
        <thead>
          <tr>
            <th style="width:70px;">RANG</th>
            <th style="width:200px;">CLIENT</th>
            <th style="width:80px;">TYPE</th>
            <th style="width:80px;">D√âPART</th>
            <th style="width:80px;">LIVRAISON</th>
            <th style="width:100px;">CHAUFFEUR</th>
            <th style="width:90px;">CAMION</th>
            <th style="width:100px;">REMORQUE</th>
            <th style="width:60px;">COPIE</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div class="buttons">
      <button class="reset-btn" id="resetBtn">Reset</button>
      <button class="save-btn" id="saveBtn">Save</button>
      <button class="send-btn" id="sendBtn">Send</button>
    </div>
  </div>
  
  <div id="notification" class="notification"></div>

  <script>
    // Configuration et constantes
    const API_URL = "https://script.google.com/macros/s/AKfycbyYx7yTmj4bnKtr6EvLf0qGSObYt0t6rs9xUEZ1q2ANniFoRDW-wP4etQ7kOMZSVgA_Xw/exec";
    const CHAUFFEUR_MAP = {
      "AP": { nom: "Audrey", tel: "4188737539" },
      "MD": { nom: "Mathieu", tel: "4183264730" },
      "RPE": { nom: "Raymond", tel: "4185550001" }
    };
    const STORAGE_KEYS = {
      note: "dispo_note",
      date: "dispo_date",
      rows: "dispo_rows",
      camions: "dispo_camions",
      remorques: "dispo_remorques"
    };
    const DAYS_FR = ["Dimanche", "Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi"];
    const MONTHS_FR = ["janvier", "f√©vrier", "mars", "avril", "mai", "juin", "juillet", "ao√ªt", "septembre", "octobre", "novembre", "d√©cembre"];

    // Donn√©es pour les listes d√©roulantes (habituellement, elles seraient charg√©es depuis un autre fichier)
    let CAMIONS = [];
    let REMORQUES = [];

    // √âl√©ments DOM
    const elements = {
      dateSelect: document.getElementById("dateSelect"),
      noteField: document.getElementById("note"),
      tableBody: document.getElementById("tableBody"),
      dispoTable: document.getElementById("dispoTable"),
      resetBtn: document.getElementById("resetBtn"),
      saveBtn: document.getElementById("saveBtn"),
      sendBtn: document.getElementById("sendBtn"),
      menuToggle: document.getElementById("menuToggle"),
      menuDropdown: document.getElementById("menuDropdown"),
      notification: document.getElementById("notification")
    };
    
    // Chargement des donn√©es des v√©hicules depuis une autre page
    async function loadVehicleData() {
      try {
        // Dans un contexte r√©el, on pourrait charger depuis un fichier JSON ou une API
        // Pour cet exemple, on va simuler des donn√©es
        const camionsData = localStorage.getItem(STORAGE_KEYS.camions);
        const remorquesData = localStorage.getItem(STORAGE_KEYS.remorques);
        
        // Si aucune donn√©e n'existe encore, on cr√©e des exemples
        if (!camionsData) {
          CAMIONS = [
            { id: "1103", disponible: true },
            { id: "1202", disponible: true },
            { id: "1303", disponible: true },
            { id: "1404", disponible: true },
            { id: "1502", disponible: true },
            { id: "1603", disponible: true },
            { id: "1703", disponible: true },
            { id: "1803", disponible: true }
          
          ];
          localStorage.setItem(STORAGE_KEYS.camions, JSON.stringify(CAMIONS));
        } else {
          CAMIONS = JSON.parse(camionsData);
        }
        
        if (!remorquesData) {
          REMORQUES = [
            { id: "1505", disponible: true },
            { id: "1605", disponible: true },
            { id: "1805", disponible: true },
            { id: "1905", disponible: true },
            { id: "1906", disponible: true },
            { id: "2006", disponible: true },
            { id: "2205", disponible: true },
            { id: "2405", disponible: true },
            { id: "2506", disponible: true },
            { id: "2706", disponible: true }
            
          ];
          localStorage.setItem(STORAGE_KEYS.remorques, JSON.stringify(REMORQUES));
        } else {
          REMORQUES = JSON.parse(remorquesData);
        }
      } catch (error) {
        showNotification("Erreur lors du chargement des v√©hicules", "error");
        console.error("Erreur lors du chargement des v√©hicules:", error);
      }
    }
    
    // Fonction pour mettre √† jour le statut des v√©hicules
    function updateVehicleStatus(type, id, isBooked) {
      if (type === 'camion') {
        const index = CAMIONS.findIndex(c => c.id === id);
        if (index !== -1) {
          CAMIONS[index].disponible = !isBooked;
          localStorage.setItem(STORAGE_KEYS.camions, JSON.stringify(CAMIONS));
        }
      } else if (type === 'remorque') {
        const index = REMORQUES.findIndex(r => r.id === id);
        if (index !== -1) {
          REMORQUES[index].disponible = !isBooked;
          localStorage.setItem(STORAGE_KEYS.remorques, JSON.stringify(REMORQUES));
        }
      }
    }
    
    // Fonction pour obtenir des v√©hicules disponibles
    function getAvailableVehicles(type) {
      const vehicles = type === 'camion' ? CAMIONS : REMORQUES;
      return vehicles.filter(v => v.disponible);
    }
    
    // Fonctions pour la gestion des lignes du tableau
    function createRow() {
      const row = document.createElement("tr");
      
      // Cr√©er les cellules de base
      row.innerHTML = `
        <td contenteditable inputmode="numeric"></td>
        <td contenteditable></td>
        <td contenteditable></td>
        <td contenteditable></td>
        <td contenteditable></td>
        <td contenteditable></td>
        <td></td>
        <td></td>
        <td><button class="copy-btn">üìã</button></td>
      `;
      
      // Cr√©er les s√©lecteurs pour camion et remorque
      const camionCell = row.cells[6];
      const remorqueCell = row.cells[7];
      
      // S√©lecteur de camion
      const camionSelect = document.createElement("select");
      camionSelect.className = "vehicle-select";
      camionSelect.innerHTML = '<option value="">-</option>';
      
      CAMIONS.forEach(camion => {
        const option = document.createElement("option");
        option.value = camion.id;
        option.textContent = camion.id;
        option.disabled = !camion.disponible;
        camionSelect.appendChild(option);
      });
      
      camionSelect.addEventListener("change", () => {
        const selectedId = camionSelect.value;
        const previousId = camionCell.dataset.previousValue;
        
        // Mettre √† jour le statut des camions
        if (previousId) {
          updateVehicleStatus('camion', previousId, false);
        }
        
        if (selectedId) {
          updateVehicleStatus('camion', selectedId, true);
          camionCell.classList.add("booked");
        } else {
          camionCell.classList.remove("booked");
        }
        
        camionCell.dataset.previousValue = selectedId;
      });
      
      camionCell.appendChild(camionSelect);
      
      // S√©lecteur de remorque
      const remorqueSelect = document.createElement("select");
      remorqueSelect.className = "vehicle-select";
      remorqueSelect.innerHTML = '<option value="">-</option>';
      
      REMORQUES.forEach(remorque => {
        const option = document.createElement("option");
        option.value = remorque.id;
        option.textContent = remorque.id;
        option.disabled = !remorque.disponible;
        remorqueSelect.appendChild(option);
      });
      
      remorqueSelect.addEventListener("change", () => {
        const selectedId = remorqueSelect.value;
        const previousId = remorqueCell.dataset.previousValue;
        
        // Mettre √† jour le statut des remorques
        if (previousId) {
          updateVehicleStatus('remorque', previousId, false);
        }
        
        if (selectedId) {
          updateVehicleStatus('remorque', selectedId, true);
          remorqueCell.classList.add("booked");
        } else {
          remorqueCell.classList.remove("booked");
        }
        
        remorqueCell.dataset.previousValue = selectedId;
      });
      
      remorqueCell.appendChild(remorqueSelect);
      
      // Attacher l'√©v√©nement de copie
      const copyBtn = row.querySelector(".copy-btn");
      copyBtn.addEventListener("click", () => copyRow(row));
      
      return row;
    }

    function generateDefaultRows(n = 9) {
      elements.tableBody.innerHTML = "";
      for (let i = 0; i < n; i++) {
        elements.tableBody.appendChild(createRow());
      }
    }
    
    // Fonctions pour les notifications
    function showNotification(message, type = "success") {
      const notification = elements.notification;
      notification.textContent = message;
      notification.className = "notification " + type;
      notification.classList.add("show");
      
      setTimeout(() => {
        notification.classList.remove("show");
      }, 3000);
    }
    
    // Fonctions pour les op√©rations principales
    function formatDate(dateStr) {
      if (!dateStr) return "";
      
      const dateObj = new Date(dateStr + "T00:00:00");
      const dayName = DAYS_FR[dateObj.getDay()];
      const dayNum = dateObj.getDate();
      const monthName = MONTHS_FR[dateObj.getMonth()];
      return `${dayName} le ${dayNum} ${monthName}`;
    }

    function copyRow(row) {
      const cells = row.querySelectorAll("td");
      const camionSelect = cells[6].querySelector("select");
      const remorqueSelect = cells[7].querySelector("select");
      
      const rawCode = (cells[5]?.textContent || "").trim().toUpperCase();
      const chauffeur = CHAUFFEUR_MAP[rawCode] || { nom: rawCode, tel: "" };
      
      const values = [
        chauffeur.nom,
        (cells[1]?.textContent || "").trim().toUpperCase(),
        (cells[2]?.textContent || "").trim().toUpperCase(),
        (cells[3]?.textContent || "").trim().toUpperCase(),
        (cells[4]?.textContent || "").trim().toUpperCase(),
        camionSelect ? camionSelect.value : "",
        remorqueSelect ? remorqueSelect.value : ""
      ];
      
      const labels = ["Chauffeur", "Client", "Type", "D√©part", "Livraison", "Camion", "Remorque"];
      const dayFormatted = formatDate(elements.dateSelect.value);
      
      let sms = `Salut,\nVoici ton voyage pour ${dayFormatted}\n\n`;
      sms += labels.map((label, idx) => `${label}: ${values[idx]}`).join("\n");
      sms += `\n\nMerci !`;
      
      const smsEncoded = encodeURIComponent(sms);
      const href = chauffeur.tel ? `sms:${chauffeur.tel}?body=${smsEncoded}` : `sms:?body=${smsEncoded}`;
      
      // Cr√©ation et clic du lien
      const link = document.createElement("a");
      link.href = href;
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification("SMS pr√©par√© pour " + chauffeur.nom);
    }

    function resetForm() {
      if (!confirm("√ätes-vous s√ªr de vouloir r√©initialiser le formulaire ?")) {
        return;
      }
      
      elements.noteField.value = "";
      elements.dateSelect.value = "";
      
      // On ne supprime pas les donn√©es des v√©hicules
      const camionsData = localStorage.getItem(STORAGE_KEYS.camions);
      const remorquesData = localStorage.getItem(STORAGE_KEYS.remorques);
      
      localStorage.clear();
      
      // On remet les donn√©es des v√©hicules
      if (camionsData) localStorage.setItem(STORAGE_KEYS.camions, camionsData);
      if (remorquesData) localStorage.setItem(STORAGE_KEYS.remorques, remorquesData);
      
      // R√©initialiser les camions et remorques comme disponibles
      CAMIONS.forEach(c => c.disponible = true);
      REMORQUES.forEach(r => r.disponible = true);
      
      localStorage.setItem(STORAGE_KEYS.camions, JSON.stringify(CAMIONS));
      localStorage.setItem(STORAGE_KEYS.remorques, JSON.stringify(REMORQUES));
      
      // G√©n√©rer √† nouveau les lignes
      generateDefaultRows(9);
      
      showNotification("Formulaire r√©initialis√©");
    }

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEYS.note, elements.noteField.value);
        localStorage.setItem(STORAGE_KEYS.date, elements.dateSelect.value);
        
        // Sauvegarder les lignes avec les v√©hicules s√©lectionn√©s
        const rows = Array.from(document.querySelectorAll("#dispoTable tbody tr")).map(tr => {
          const cells = Array.from(tr.querySelectorAll("td"));
          const values = cells.slice(0, 6).map(td => td.textContent.trim());
          
          // Ajouter les valeurs des s√©lecteurs
          const camionSelect = cells[6].querySelector("select");
          const remorqueSelect = cells[7].querySelector("select");
          
          values.push(camionSelect ? camionSelect.value : "");
          values.push(remorqueSelect ? remorqueSelect.value : "");
          
          return values;
        });
        
        localStorage.setItem(STORAGE_KEYS.rows, JSON.stringify(rows));
        
        // Sauvegarder l'√©tat des v√©hicules
        localStorage.setItem(STORAGE_KEYS.camions, JSON.stringify(CAMIONS));
        localStorage.setItem(STORAGE_KEYS.remorques, JSON.stringify(REMORQUES));
        
        showNotification("Donn√©es sauvegard√©es avec succ√®s");
      } catch (err) {
        showNotification("Erreur lors de la sauvegarde : " + err.message, "error");
        console.error("Erreur lors de la sauvegarde:", err);
      }
    }

    function sendForm() {
      if (!confirm("√ätes-vous s√ªr de vouloir envoyer ces disponibilit√©s ?")) {
        return;
      }
      
      const tableClone = elements.dispoTable.cloneNode(true);
      const rows = tableClone.querySelectorAll("tbody tr");
      
      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        
        // Transformation en majuscules
        for (let i = 0; i < 6; i++) {
          const cell = cells[i];
          if (cell.hasAttribute("contenteditable")) {
            cell.innerText = cell.innerText.trim().toUpperCase();
          }
        }
        
        // Remplacer les selects par leur valeur textuelle
        const camionCell = cells[6];
        const remorqueCell = cells[7];
        
        const camionSelect = camionCell.querySelector("select");
        if (camionSelect) {
          camionCell.innerText = camionSelect.value;
        }
        
        const remorqueSelect = remorqueCell.querySelector("select");
        if (remorqueSelect) {
          remorqueCell.innerText = remorqueSelect.value;
        }
        
        // Suppression des boutons de copie
        const copyCell = cells[8];
        if (copyCell) copyCell.innerHTML = "";
      });
      
      const data = {
        note: elements.noteField.value,
        date: elements.dateSelect.value,
        table: tableClone.outerHTML
      };
      
      // Afficher un indicateur de chargement
      showNotification("Envoi en cours...");
      
      fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(() => {
        showNotification("Disponibilit√©s envoy√©es avec succ√®s !");
      })
      .catch(error => {
        console.error("Erreur lors de l'envoi:", error);
        showNotification("Erreur lors de l'envoi. Veuillez r√©essayer.", "error");
      });
    }
    
    // Gestion de la navigation avec fl√®che
    function setupArrowNavigation() {
      const arrowBtn = document.createElement("button");
      arrowBtn.textContent = "‚û°Ô∏è";
      arrowBtn.className = "arrow-next";
      document.body.appendChild(arrowBtn);
      
      let currentCell = null;
      
      // Fonction pour mettre √† jour la position du bouton fl√®che
      function updateArrowPosition() {
        if (!currentCell) return;
        const rect = currentCell.getBoundingClientRect();
        arrowBtn.style.top = `${window.scrollY + rect.top + 5}px`;
        arrowBtn.style.left = `${window.scrollX + rect.right + 5}px`;
        arrowBtn.style.display = "inline-block";
      }
      
      // D√©placement vers la cellule suivante
      function moveToNextCell() {
        if (!currentCell) return;
        const row = currentCell.closest("tr");
        const cells = Array.from(row.querySelectorAll("td")).filter(
          td => td.hasAttribute("contenteditable") || td.querySelector("select")
        );
        const idx = cells.indexOf(currentCell);
        
        let next = null;
        
        if (idx < cells.length - 1) {
          next = cells[idx + 1];
        } else {
          const nextRow = row.nextElementSibling;
          if (nextRow) {
            const nextCells = Array.from(nextRow.querySelectorAll("td")).filter(
              td => td.hasAttribute("contenteditable") || td.querySelector("select")
            );
            if (nextCells.length) next = nextCells[0];
          }
        }
        
        if (next) {
          // Focus sur la cellule ou le select √† l'int√©rieur
          const select = next.querySelector("select");
          if (select) {
            select.focus();
          } else {
            next.focus();
          }
          
          currentCell = next;
          
          // Attendre le rendu avant scroll
          setTimeout(() => {
            next.scrollIntoView({
              behavior: "smooth",
              block: "nearest",
              inline: "center"
            });
            updateArrowPosition();
          }, 50);
        }
      }
      
      // √âv√©nements
      elements.dispoTable.addEventListener("focusin", (e) => {
        if (e.target.tagName === "TD" && e.target.hasAttribute("contenteditable")) {
          currentCell = e.target;
          updateArrowPosition();
        } else if (e.target.tagName === "SELECT" && e.target.classList.contains("vehicle-select")) {
          currentCell = e.target.closest("td");
          updateArrowPosition();
        }
        
        // Assurer que la cellule est visible
        if (currentCell) {
          currentCell.scrollIntoView({
            behavior: "smooth",
            block: "nearest",
            inline: "center"
          });
        }
      });
      
      document.addEventListener("scroll", updateArrowPosition);
      
      arrowBtn.addEventListener("click", moveToNextCell);
      
      document.addEventListener("click", (e) => {
        if (!e.target.closest("td") && e.target !== arrowBtn) {
          arrowBtn.style.display = "none";
          currentCell = null;
        }
      });
    }
    
    // √âv√©nement pour convertir le texte en majuscules pendant la saisie
    document.addEventListener("input", (e) => {
      if (e.target.matches("td[contenteditable]")) {
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        const cursorPos = range.startOffset;
        
        const upper = e.target.textContent.toUpperCase();
        e.target.textContent = upper;
        
        // Remet le curseur √† la bonne place
        if (e.target.firstChild) {
          range.setStart(e.target.firstChild, Math.min(cursorPos, e.target.textContent.length));
          range.setEnd(e.target.firstChild, Math.min(cursorPos, e.target.textContent.length));
          selection.removeAllRanges();
          selection.addRange(range);
        }
      }
    });
    
    // Gestion du menu
    function setupMenu() {
      if (elements.menuToggle && elements.menuDropdown) {
        elements.menuToggle.addEventListener("click", () => {
          elements.menuDropdown.classList.toggle("show");
        });
        
        document.addEventListener("click", (e) => {
          if (!elements.menuToggle.contains(e.target) && !elements.menuDropdown.contains(e.target)) {
            elements.menuDropdown.classList.remove("show");
          }
        });
      }
    }
    
    // Initialisation
    function init() {
      // Attacher les gestionnaires d'√©v√©nements
      elements.resetBtn.addEventListener("click", resetForm);
      elements.saveBtn.addEventListener("click", saveData);
      elements.sendBtn.addEventListener("click", sendForm);
      
      // Charger les donn√©es sauvegard√©es
      const note = localStorage.getItem(STORAGE_KEYS.note);
      const date = localStorage.getItem(STORAGE_KEYS.date);
      const savedRows = JSON.parse(localStorage.getItem(STORAGE_KEYS.rows) || "[]");
      
      elements.tableBody.innerHTML = "";
      
      if (savedRows.length > 0) {
        savedRows.forEach(data => {
          const row = createRow();
          const cells = row.querySelectorAll("td");
          data.forEach((val, idx) => {
            cells[idx].textContent = val;
          });
          elements.tableBody.appendChild(row);
        });
      } else {
        generateDefaultRows(9);
      }
      
      if (note) elements.noteField.value = note;
      if (date) elements.dateSelect.value = date;
      
      // Configurer les fonctionnalit√©s
      setupArrowNavigation();
      setupMenu();
    }
    
    // D√©marrer l'application quand la page est charg√©e
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
